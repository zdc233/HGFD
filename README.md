# HG-Lane

Code for "HG-Lane: High-Fidelity Generation of Lane Scenes under Adverse Weather and Lighting Conditions without Re-annotation"(AAAI-26 Manuscript Submitted)



## Installation

This part refers to ComfyUI. For more details or check the errors of installation, you can see in it.

### Clone this repository

Clone this code to your workspace. 
We call this directory as `$HGLane_ROOT`

Then, clone the ComfyUI and copy it to your workspace.

```bash
cp -r ComfyUI-master/* $HGLane_ROOT
```

### Prerequisites

Only test on Ubuntu24.04 with:

- Python >= 3.8 (tested with Python3.12.11)
- PyTorch >= 1.13.1 (tested with Pytorch2.2.0)
- CUDA (tested with cuda12.1)
- Other dependencies described in `requirements.txt`

### Create a conda virtual environment and activate it (conda is optional)

```Shell
conda create -n comfyui python=3.12.11 -y
conda activate comfyui
```

### Install dependencies

```Shell
# Install pytorch firstly, the cudatoolkit version should be same in your system.
conda install pytorch torchvision cudatoolkit=12.1 -c pytorch

# Or you can install via pip
pip install torch==2.2.0 torchvision==0.17.0 torchaudio==2.2.0 --index-url https://download.pytorch.org/whl/cu121

# Then install the requirements.txt
pip install -r requirements.txt
```



## Data preparation

Download CULane datasets. Then extract them to `$CULANEROOT`. Create link to `data` directory. 

```
cd $HGLane_ROOT
mkdir -p hglane/data
ln -s $CULANEROOT hglane/data/CULane
```

For our datasets, you should have structure like this:

```
$CULANEROOT/driver_xx_xxframe    # data folders x6
$CULANEROOT/laneseg_label_w16    # lane segmentation labels
$CULANEROOT/list                 # data lists
```

Then prepara the output dataset folder `$OUTROOT` :

```bash
cd $HGLane_ROOT
ln -s $OUTROOT hglane/data/HGLane
```



## Getting Started

### Sampling in CULane

```bash
cd HGLane_ROOT/hglane
python sampling.py
```

### Run the ComfyUI workflow

```bash
cd HGLane_ROOT
python main.py
```

### Run the pipeline

```
cd HGLane_ROOT/hglane
python culane.py
```

### Run the process

please do this step after all images is generated by our framework.

```bash
cd HGLane_ROOT/hglane
python process.py
```

Finally, you can get the dataset of our framework. However, you need to generate the `laneseg_label_w16` `list`for the lane detection model to train and test. This can be generated by some tools (eg. seg_label_generate). We also provide our `laneseg_label_w16` `list` to download.



## Download Our Dataset

You can download our dataset on [HGLane](https://drive.google.com/file/d/1QUbxiapzoUBwl9gsLeeRLggM97Pysa9W/view?usp=sharing) **(anonymous).** The dataset is divided in 7:1:2.

| Category | Total | Train |  Val |  Test |
| :------- | ----: | ----: | ---: | ----: |
| Normal   | 5,000 | 3,500 |  500 | 1,000 |
| Snow     | 5,000 | 3,500 |  500 | 1,000 |
| Rain     | 5,000 | 3,500 |  500 | 1,000 |
| Fog      | 5,000 | 3,500 |  500 | 1,000 |
| Night    | 5,000 | 3,500 |  500 | 1,000 |
| Dusk     | 5,000 | 3,500 |  500 | 1,000 |